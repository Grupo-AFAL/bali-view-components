#!/usr/bin/env bash
#
# Benchmark Lookbook page load times.
#
# Usage:
#   bin/benchmark-lookbook                    # Benchmark running server on port 3001
#   bin/benchmark-lookbook --port 3000        # Benchmark server on different port
#   bin/benchmark-lookbook --label "dev"      # Add label to results
#   bin/benchmark-lookbook --save             # Save results for comparison
#   bin/benchmark-lookbook --compare          # Compare saved results
#

set -e

cd "$(dirname "$0")/.."

PORT="3001"
LABEL=""
SAVE_RESULTS=false
COMPARE_MODE=false
RESULTS_DIR="/tmp/lookbook_benchmarks"

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --port)
      PORT="$2"
      shift 2
      ;;
    --label)
      LABEL="$2"
      shift 2
      ;;
    --save)
      SAVE_RESULTS=true
      shift
      ;;
    --compare)
      COMPARE_MODE=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

BASE_URL="http://localhost:$PORT"
LOOKBOOK_URL="$BASE_URL/lookbook"

# Pages to benchmark (mix of simple and complex)
PAGES=(
  "/lookbook/inspect/bali/button/default"
  "/lookbook/inspect/bali/card/default"
  "/lookbook/inspect/bali/modal/default"
  "/lookbook/inspect/bali/data_table/default"
  "/lookbook/inspect/bali/icon/default"
)

# Number of requests per page
REQUESTS_PER_PAGE=3

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Check if server is running
check_server() {
  curl -s -o /dev/null -w "%{http_code}" "$LOOKBOOK_URL" 2>/dev/null | grep -q "200\|302"
}

# Benchmark a single URL
benchmark_url() {
  local url="$1"
  local times=()

  for i in $(seq 1 $REQUESTS_PER_PAGE); do
    # Use curl to measure total time (in seconds)
    local time=$(curl -s -o /dev/null -w "%{time_total}" "$BASE_URL$url" 2>/dev/null)
    times+=("$time")
  done

  # Calculate average (using awk for floating point)
  local avg=$(printf '%s\n' "${times[@]}" | awk '{sum+=$1} END {printf "%.3f", sum/NR}')
  local min=$(printf '%s\n' "${times[@]}" | sort -n | head -1)
  local max=$(printf '%s\n' "${times[@]}" | sort -n | tail -1)

  echo "$avg $min $max"
}

# Run full benchmark
run_benchmark() {
  local label="${LABEL:-port-$PORT}"
  local total_avg=0

  echo ""
  echo "════════════════════════════════════════════════════════════════"
  echo "  LOOKBOOK BENCHMARK${LABEL:+ - $LABEL}"
  echo "  Server: $BASE_URL"
  echo "════════════════════════════════════════════════════════════════"
  echo ""
  printf "%-50s %8s %8s %8s\n" "Page" "Avg" "Min" "Max"
  echo "────────────────────────────────────────────────────────────────"

  # Warm-up request (first request is always slow)
  log_info "Warm-up request..."
  curl -s -o /dev/null "$BASE_URL${PAGES[0]}" 2>/dev/null
  sleep 1

  for page in "${PAGES[@]}"; do
    local result=$(benchmark_url "$page")
    local avg=$(echo "$result" | cut -d' ' -f1)
    local min=$(echo "$result" | cut -d' ' -f2)
    local max=$(echo "$result" | cut -d' ' -f3)

    # Color code based on time
    local color=$GREEN
    if (( $(echo "$avg > 2.0" | bc -l) )); then
      color=$RED
    elif (( $(echo "$avg > 1.0" | bc -l) )); then
      color=$YELLOW
    fi

    local short_page=$(echo "$page" | sed 's|/lookbook/inspect/bali/||')
    printf "%-50s ${color}%7.3fs${NC} %7.3fs %7.3fs\n" "$short_page" "$avg" "$min" "$max"

    total_avg=$(echo "$total_avg + $avg" | bc -l)
  done

  local overall_avg=$(echo "scale=3; $total_avg / ${#PAGES[@]}" | bc -l)

  echo "────────────────────────────────────────────────────────────────"
  printf "%-50s %8.3fs\n" "OVERALL AVERAGE" "$overall_avg"
  echo ""

  # Performance assessment
  if (( $(echo "$overall_avg < 0.5" | bc -l) )); then
    log_success "Excellent! Page loads under 500ms"
  elif (( $(echo "$overall_avg < 1.0" | bc -l) )); then
    log_success "Good. Page loads under 1 second"
  elif (( $(echo "$overall_avg < 2.0" | bc -l) )); then
    log_warn "Acceptable. Page loads under 2 seconds"
  else
    log_error "Slow! Page loads over 2 seconds. Try: RAILS_ENV=lookbook bin/rails s -p 3001"
  fi

  echo ""

  # Save results if requested
  if [ "$SAVE_RESULTS" = true ]; then
    mkdir -p "$RESULTS_DIR"
    local filename="$RESULTS_DIR/${label}.txt"
    echo "$overall_avg" > "$filename"
    log_info "Results saved to $filename"
  fi
}

# Compare saved results
compare_results() {
  echo ""
  echo "════════════════════════════════════════════════════════════════"
  echo "  SAVED BENCHMARK RESULTS"
  echo "════════════════════════════════════════════════════════════════"
  echo ""

  if [ ! -d "$RESULTS_DIR" ] || [ -z "$(ls -A $RESULTS_DIR 2>/dev/null)" ]; then
    log_error "No saved results found. Run benchmarks with --save first."
    echo ""
    echo "Example:"
    echo "  # Start development server, then:"
    echo "  bin/benchmark-lookbook --label development --save"
    echo ""
    echo "  # Start lookbook server, then:"
    echo "  bin/benchmark-lookbook --label lookbook --save"
    echo ""
    echo "  # Compare:"
    echo "  bin/benchmark-lookbook --compare"
    exit 1
  fi

  printf "%-20s %10s\n" "Label" "Avg Time"
  echo "────────────────────────────────────────────────────────────────"

  local best_time=999
  local best_label=""

  for file in "$RESULTS_DIR"/*.txt; do
    local label=$(basename "$file" .txt)
    local avg=$(cat "$file")

    local color=$GREEN
    if (( $(echo "$avg > 2.0" | bc -l) )); then
      color=$RED
    elif (( $(echo "$avg > 1.0" | bc -l) )); then
      color=$YELLOW
    fi

    printf "%-20s ${color}%9.3fs${NC}\n" "$label" "$avg"

    if (( $(echo "$avg < $best_time" | bc -l) )); then
      best_time=$avg
      best_label=$label
    fi
  done

  echo "────────────────────────────────────────────────────────────────"
  echo ""
  log_success "Fastest: $best_label (${best_time}s)"
  echo ""
}

# Main
if [ "$COMPARE_MODE" = true ]; then
  compare_results
else
  if ! check_server; then
    log_error "No server running on port $PORT"
    echo ""
    echo "Start a server first:"
    echo "  cd spec/dummy"
    echo "  bin/dev                                    # Development (with watchers)"
    echo "  RAILS_ENV=lookbook bin/rails s -p 3001    # Lookbook (optimized)"
    echo ""
    echo "Then run:"
    echo "  bin/benchmark-lookbook --label development --save"
    echo "  bin/benchmark-lookbook --label lookbook --save"
    echo "  bin/benchmark-lookbook --compare"
    exit 1
  fi

  run_benchmark
fi
