<div id="<%= id %>"
     class="filters"
     data-controller="filters"
     data-filters-url-value="<%= url %>"
     data-filters-attributes-value="<%= attributes_json %>"
     data-filters-apply-mode-value="<%= apply_mode %>"
     data-filters-max-groups-value="<%= max_groups %>"
     data-filters-popover-value="<%= popover %>"
     data-filters-translations-value="<%= translations_json %>"
     data-turbo-permanent>

  <% if popover %>
    <%# Popover mode: search input + trigger button + dropdown %>
    <div class="flex flex-wrap items-center gap-3">
      <% if search_enabled? %>
        <%# Quick search input %>
        <%= form_with url: url, method: :get, class: 'contents', data: { turbo_action: 'replace' } do %>
          <div class="join focus-within:ring-2 focus-within:ring-primary/20 rounded-lg">
            <input type="text"
                   name="<%= search_field_name %>"
                   value="<%= search_value %>"
                   placeholder="<%= search_placeholder %>"
                   class="input input-bordered join-item w-64"
                   data-filters-target="searchInput">
            <button type="submit" class="btn btn-primary join-item">
              <%= render Bali::Icon::Component.new('search', class: 'w-4 h-4') %>
            </button>
          </div>
        <% end %>
      <% end %>

      <%# Trigger button %>
      <div class="relative" data-filters-target="dropdown">
        <button type="button"
                class="btn btn-outline gap-2"
                data-action="click->filters#toggleDropdown">
          <%= render Bali::Icon::Component.new('filter', class: 'w-4 h-4') %>
          <%= button_text %>
          <% if active_filters? %>
            <span class="badge badge-primary badge-sm"><%= active_filter_count %></span>
          <% end %>
        </button>

        <%# Dropdown content - hidden by default, shown via JS %>
        <div class="absolute left-0 top-full hidden z-50 mt-2 shadow-xl bg-base-100 rounded-box border border-base-200 w-[40rem] max-w-[calc(100vw-2rem)]"
             data-filters-target="dropdownContent">

          <%= form_with url: url, method: :get,
                data: {
                  filters_target: 'form',
                  turbo_action: 'replace'
                },
                class: 'w-full' do |f| %>

            <div class="p-4 space-y-4">
              <%# Filter groups container - no header for compact layout %>
              <div data-filters-target="groupsContainer" class="space-y-4">
                <% filter_groups.each_with_index do |group, group_idx| %>
                  <% if group_idx > 0 %>
                    <%# Group combinator divider (AND/OR toggle between groups) %>
                    <div class="flex items-center justify-center gap-2 my-2">
                      <div class="flex-1 border-t border-base-300"></div>
                      <input type="hidden" name="q[m]" value="<%= combinator %>" data-filters-target="groupCombinator">
                      <div class="join" data-filters-target="groupCombinatorToggle">
                        <button type="button"
                                class="join-item btn btn-xs w-10 <%= combinator == 'and' ? 'btn-primary' : 'btn-outline' %>"
                                data-action="filters#setGroupCombinator"
                                data-combinator="and">
                          <%= t('bali.filters.combinators.and', default: 'AND') %>
                        </button>
                        <button type="button"
                                class="join-item btn btn-xs w-10 <%= combinator == 'or' ? 'btn-primary' : 'btn-outline' %>"
                                data-action="filters#setGroupCombinator"
                                data-combinator="or">
                          <%= t('bali.filters.combinators.or', default: 'OR') %>
                        </button>
                      </div>
                      <div class="flex-1 border-t border-base-300"></div>
                    </div>
                  <% end %>

                  <%= render Bali::Filters::FilterGroup::Component.new(
                        group: group,
                        index: group_idx,
                        available_attributes: available_attributes,
                        removable: filter_groups.size > 1
                      ) %>
                <% end %>
              </div>

              <%# Compact footer: Clear all (left) | Add group + Reset + Apply (right) %>
              <div class="flex justify-between items-center gap-2 pt-3 border-t border-base-200">
                <button type="button"
                        class="btn btn-ghost btn-xs text-error"
                        data-action="filters#clearAll"
                        data-filters-target="clearButton">
                  <%= t('bali.filters.clear_all', default: 'Clear all') %>
                </button>

                <div class="flex items-center gap-2">
                  <button type="button"
                          class="btn btn-ghost btn-sm text-primary gap-1"
                          data-action="filters#addGroup"
                          data-filters-target="addGroupButton">
                    <%= render Bali::Icon::Component.new('plus', class: 'w-4 h-4') %>
                    <%= t('bali.filters.add_group', default: 'Add filter group') %>
                  </button>
                  <button type="button"
                          class="btn btn-ghost btn-sm"
                          data-action="filters#reset">
                    <%= t('bali.filters.reset', default: 'Reset') %>
                  </button>
                  <button type="submit"
                          class="btn btn-primary btn-sm"
                          data-action="filters#apply">
                    <%= render Bali::Icon::Component.new('check', class: 'w-4 h-4') %>
                    <%= t('bali.filters.apply', default: 'Apply') %>
                  </button>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# Applied filter tags (shown inline with button) %>
      <% if applied_tags? %>
        <%= applied_tags %>
      <% end %>
    </div>

  <% else %>
    <%# Inline mode: original layout %>
    <% if applied_tags? %>
      <div class="mb-4">
        <%= applied_tags %>
      </div>
    <% end %>

    <%= form_with url: url, method: :get,
          data: {
            filters_target: 'form',
            turbo_action: 'replace'
          },
          class: 'w-full' do |f| %>

      <%= render Bali::Card::Component.new(style: :bordered, body_class: 'p-4 sm:p-6 space-y-4') do %>
          <%# Header %>
          <div class="flex justify-between items-center">
            <h3 class="font-semibold text-lg flex items-center gap-2">
              <%= render Bali::Icon::Component.new('filter', class: 'w-5 h-5') %>
              <%= t('bali.filters.title', default: 'Advanced Filters') %>
            </h3>
            <button type="button"
                    class="btn btn-ghost btn-sm text-error"
                    data-action="filters#clearAll"
                    data-filters-target="clearButton">
              <%= t('bali.filters.clear_all', default: 'Clear all') %>
            </button>
          </div>

          <div class="divider my-0"></div>

          <%# Filter groups container %>
              <div data-filters-target="groupsContainer" class="space-y-4">
                <% filter_groups.each_with_index do |group, group_idx| %>
                  <% if group_idx > 0 %>
                    <%# Group combinator divider (AND/OR toggle between groups) %>
                    <div class="flex items-center justify-center gap-2 my-2">
                      <div class="flex-1 border-t border-base-300"></div>
                      <input type="hidden" name="q[m]" value="<%= combinator %>" data-filters-target="groupCombinator">
                      <div class="join" data-filters-target="groupCombinatorToggle">
                        <button type="button"
                                class="join-item btn btn-xs w-10 <%= combinator == 'and' ? 'btn-primary' : 'btn-outline' %>"
                                data-action="filters#setGroupCombinator"
                                data-combinator="and">
                          <%= t('bali.filters.combinators.and', default: 'AND') %>
                        </button>
                        <button type="button"
                                class="join-item btn btn-xs w-10 <%= combinator == 'or' ? 'btn-primary' : 'btn-outline' %>"
                                data-action="filters#setGroupCombinator"
                                data-combinator="or">
                          <%= t('bali.filters.combinators.or', default: 'OR') %>
                        </button>
                      </div>
                      <div class="flex-1 border-t border-base-300"></div>
                    </div>
                  <% end %>

                  <%= render Bali::Filters::FilterGroup::Component.new(
                        group: group,
                        index: group_idx,
                        available_attributes: available_attributes,
                        removable: filter_groups.size > 1
                      ) %>
                <% end %>
              </div>

          <%# Add group button %>
          <button type="button"
                  class="btn btn-ghost btn-sm gap-2 w-full sm:w-auto text-primary hover:bg-primary/10"
                  data-action="filters#addGroup"
                  data-filters-target="addGroupButton">
            <%= render Bali::Icon::Component.new('plus', class: 'w-4 h-4') %>
            <%= t('bali.filters.add_group', default: 'Add filter group') %>
          </button>

          <div class="divider my-0"></div>

          <%# Actions %>
          <div class="flex flex-col sm:flex-row justify-end gap-2">
            <button type="button"
                    class="btn btn-ghost order-2 sm:order-1"
                    data-action="filters#reset">
              <%= t('bali.filters.reset', default: 'Reset') %>
            </button>
            <button type="submit"
                    class="btn btn-primary order-1 sm:order-2"
                    data-action="filters#apply"
                    data-filters-target="applyButton">
              <%= render Bali::Icon::Component.new('check', class: 'w-4 h-4') %>
              <%= t('bali.filters.apply', default: 'Apply Filters') %>
            </button>
          </div>
      <% end %>
    <% end %>
  <% end %>

  <%# Template for new filter group (used by Stimulus) %>
  <template data-filters-target="groupTemplate">
    <%= render Bali::Filters::FilterGroup::Component.new(
          group: { combinator: 'or', conditions: [{ attribute: '', operator: 'cont', value: '' }] },
          index: '__GROUP_INDEX__',
          available_attributes: available_attributes,
          removable: true
        ) %>
  </template>
</div>
