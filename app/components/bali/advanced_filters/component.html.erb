<div id="<%= id %>"
     class="advanced-filters"
     data-controller="advanced-filters"
     data-advanced-filters-url-value="<%= url %>"
     data-advanced-filters-attributes-value="<%= attributes_json %>"
     data-advanced-filters-apply-mode-value="<%= apply_mode %>"
     data-advanced-filters-max-groups-value="<%= max_groups %>"
     data-advanced-filters-popover-value="<%= popover %>"
     data-turbo-permanent>

  <% if popover %>
    <%# Popover mode: trigger button + dropdown %>
    <div class="flex flex-wrap items-center gap-3">
      <%# Trigger button %>
      <div class="relative" data-advanced-filters-target="dropdown">
        <button type="button"
                class="btn btn-outline gap-2"
                data-action="click->advanced-filters#toggleDropdown">
          <%= render Bali::Icon::Component.new('filter', class: 'w-4 h-4') %>
          <%= button_text %>
          <% if has_active_filters? %>
            <span class="badge badge-primary badge-sm"><%= active_filter_count %></span>
          <% end %>
        </button>

        <%# Dropdown content - hidden by default, shown via JS %>
        <div class="absolute left-0 top-full hidden z-50 mt-2 shadow-xl bg-base-100 rounded-box border border-base-200 w-[40rem] max-w-[calc(100vw-2rem)]"
             data-advanced-filters-target="dropdownContent">

          <%= form_with url: url, method: :get,
                data: {
                  advanced_filters_target: 'form',
                  turbo_action: 'replace'
                },
                class: 'w-full' do |f| %>

            <div class="p-4 space-y-4">
              <%# Compact header %>
              <div class="flex justify-between items-center pb-2 border-b border-base-200">
                <span class="font-semibold">
                  <%= t('bali.advanced_filters.title', default: 'Advanced Filters') %>
                </span>
                <button type="button"
                        class="btn btn-ghost btn-xs text-error"
                        data-action="advanced-filters#clearAll"
                        data-advanced-filters-target="clearButton">
                  <%= t('bali.advanced_filters.clear_all', default: 'Clear all') %>
                </button>
              </div>

              <%# Filter groups container %>
              <div data-advanced-filters-target="groupsContainer" class="space-y-4">
                <% filter_groups.each_with_index do |group, group_idx| %>
                  <% if group_idx > 0 %>
                    <div class="flex items-center justify-center gap-2">
                      <div class="flex-1 border-t border-base-300"></div>
                      <select class="select select-sm select-bordered font-medium"
                              name="q[m]"
                              data-advanced-filters-target="groupCombinator">
                        <option value="and" <%= 'selected' if combinator == 'and' %>>AND</option>
                        <option value="or" <%= 'selected' if combinator == 'or' %>>OR</option>
                      </select>
                      <div class="flex-1 border-t border-base-300"></div>
                    </div>
                  <% end %>

                  <%= render Bali::AdvancedFilters::FilterGroup::Component.new(
                        group: group,
                        index: group_idx,
                        available_attributes: available_attributes,
                        removable: filter_groups.size > 1
                      ) %>
                <% end %>
              </div>

              <%# Add group button %>
              <button type="button"
                      class="btn btn-outline btn-sm gap-2 w-full"
                      data-action="advanced-filters#addGroup"
                      data-advanced-filters-target="addGroupButton">
                <%= render Bali::Icon::Component.new('plus', class: 'w-4 h-4') %>
                <%= t('bali.advanced_filters.add_group', default: 'Add filter group') %>
              </button>

              <%# Actions %>
              <div class="flex justify-end gap-2 pt-2 border-t border-base-200">
                <button type="button"
                        class="btn btn-ghost btn-sm"
                        data-action="advanced-filters#reset">
                  <%= t('bali.advanced_filters.reset', default: 'Reset') %>
                </button>
                <button type="submit"
                        class="btn btn-primary btn-sm"
                        data-action="advanced-filters#apply">
                  <%= render Bali::Icon::Component.new('check', class: 'w-4 h-4') %>
                  <%= t('bali.advanced_filters.apply', default: 'Apply') %>
                </button>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# Applied filter tags (shown inline with button) %>
      <% if applied_tags? %>
        <%= applied_tags %>
      <% end %>
    </div>

  <% else %>
    <%# Inline mode: original layout %>
    <% if applied_tags? %>
      <div class="mb-4">
        <%= applied_tags %>
      </div>
    <% end %>

    <%= form_with url: url, method: :get,
          data: {
            advanced_filters_target: 'form',
            turbo_action: 'replace'
          },
          class: 'w-full' do |f| %>

      <div class="card bg-base-100 shadow-lg border border-base-200">
        <div class="card-body p-4 sm:p-6 space-y-4">
          <%# Header %>
          <div class="flex justify-between items-center">
            <h3 class="font-semibold text-lg flex items-center gap-2">
              <%= render Bali::Icon::Component.new('filter', class: 'w-5 h-5') %>
              <%= t('bali.advanced_filters.title', default: 'Advanced Filters') %>
            </h3>
            <button type="button"
                    class="btn btn-ghost btn-sm text-error"
                    data-action="advanced-filters#clearAll"
                    data-advanced-filters-target="clearButton">
              <%= t('bali.advanced_filters.clear_all', default: 'Clear all') %>
            </button>
          </div>

          <div class="divider my-0"></div>

          <%# Filter groups container %>
          <div data-advanced-filters-target="groupsContainer" class="space-y-4">
            <% filter_groups.each_with_index do |group, group_idx| %>
              <% if group_idx > 0 %>
                <div class="flex items-center justify-center gap-2">
                  <div class="flex-1 border-t border-base-300"></div>
                  <select class="select select-sm select-bordered font-medium"
                          name="q[m]"
                          data-advanced-filters-target="groupCombinator">
                    <option value="and" <%= 'selected' if combinator == 'and' %>>AND</option>
                    <option value="or" <%= 'selected' if combinator == 'or' %>>OR</option>
                  </select>
                  <div class="flex-1 border-t border-base-300"></div>
                </div>
              <% end %>

              <%= render Bali::AdvancedFilters::FilterGroup::Component.new(
                    group: group,
                    index: group_idx,
                    available_attributes: available_attributes,
                    removable: filter_groups.size > 1
                  ) %>
            <% end %>
          </div>

          <%# Add group button %>
          <button type="button"
                  class="btn btn-outline btn-sm gap-2 w-full sm:w-auto"
                  data-action="advanced-filters#addGroup"
                  data-advanced-filters-target="addGroupButton">
            <%= render Bali::Icon::Component.new('plus', class: 'w-4 h-4') %>
            <%= t('bali.advanced_filters.add_group', default: 'Add filter group') %>
          </button>

          <div class="divider my-0"></div>

          <%# Actions %>
          <div class="flex flex-col sm:flex-row justify-end gap-2">
            <button type="button"
                    class="btn btn-ghost order-2 sm:order-1"
                    data-action="advanced-filters#reset">
              <%= t('bali.advanced_filters.reset', default: 'Reset') %>
            </button>
            <button type="submit"
                    class="btn btn-primary order-1 sm:order-2"
                    data-action="advanced-filters#apply"
                    data-advanced-filters-target="applyButton">
              <%= render Bali::Icon::Component.new('check', class: 'w-4 h-4') %>
              <%= t('bali.advanced_filters.apply', default: 'Apply Filters') %>
            </button>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <%# Template for new filter group (used by Stimulus) %>
  <template data-advanced-filters-target="groupTemplate">
    <%= render Bali::AdvancedFilters::FilterGroup::Component.new(
          group: { combinator: 'or', conditions: [{ attribute: '', operator: 'cont', value: '' }] },
          index: '__GROUP_INDEX__',
          available_attributes: available_attributes,
          removable: true
        ) %>
  </template>
</div>
