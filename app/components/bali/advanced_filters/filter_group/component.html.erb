<div class="filter-group bg-base-200/50 rounded-xl p-4 relative"
     data-controller="filter-group"
     data-filter-group-index-value="<%= index %>"
     data-filter-group-combinator-value="<%= combinator %>"
     data-advanced-filters-target="group">

  <%# Remove group button (top right) %>
  <% if removable %>
    <button type="button"
            class="absolute top-2 right-2 btn btn-ghost btn-xs btn-circle text-error hover:bg-error/10"
            data-action="filter-group#removeGroup"
            title="<%= t('bali.advanced_filters.remove_group', default: 'Remove group') %>">
      <%= render Bali::Icon::Component.new('times', class: 'w-4 h-4') %>
    </button>
  <% end %>

  <%# Hidden field for group combinator %>
  <input type="hidden"
         name="<%= group_field_prefix %>[m]"
         value="<%= combinator %>"
         data-filter-group-target="combinator">

  <%# Conditions container - each row has label/toggle + condition inline %>
  <div data-filter-group-target="conditionsContainer" class="space-y-2">
    <% conditions.each_with_index do |condition, condition_idx| %>
      <div class="flex items-start gap-2" data-filter-group-target="conditionRow">
        <%# First row shows "Where", subsequent rows show AND/OR toggle %>
        <div class="w-20 shrink-0 pt-1.5">
          <% if condition_idx == 0 %>
            <span class="text-sm font-medium text-base-content/70">
              <%= t('bali.advanced_filters.where', default: 'Where') %>
            </span>
          <% else %>
            <%# AND/OR toggle switch %>
            <div class="join" data-filter-group-target="combinatorToggle">
              <button type="button"
                      class="join-item btn btn-xs w-10 <%= combinator == 'and' ? 'btn-primary' : 'btn-outline' %>"
                      data-action="filter-group#setCombinator"
                      data-combinator="and">
                AND
              </button>
              <button type="button"
                      class="join-item btn btn-xs w-10 <%= combinator == 'or' ? 'btn-primary' : 'btn-outline' %>"
                      data-action="filter-group#setCombinator"
                      data-combinator="or">
                OR
              </button>
            </div>
          <% end %>
        </div>

        <%# Condition fields %>
        <%= render Bali::AdvancedFilters::Condition::Component.new(
              condition: condition,
              group_index: index,
              condition_index: condition_idx,
              available_attributes: available_attributes
            ) %>
      </div>
    <% end %>
  </div>

  <%# Add condition button %>
  <div class="mt-3 pl-20">
    <button type="button"
            class="btn btn-ghost btn-sm gap-1 text-primary hover:bg-primary/10"
            data-action="filter-group#addCondition">
      <%= render Bali::Icon::Component.new('plus', class: 'w-4 h-4') %>
      <%= t('bali.advanced_filters.add_condition', default: 'Add condition') %>
    </button>
  </div>

  <%# Template for new condition row (used by Stimulus) %>
  <template data-filter-group-target="conditionTemplate">
    <div class="flex items-start gap-2" data-filter-group-target="conditionRow">
      <div class="w-20 shrink-0 pt-1.5">
        <div class="join" data-filter-group-target="combinatorToggle">
          <button type="button"
                  class="join-item btn btn-xs w-10 <%= combinator == 'and' ? 'btn-primary' : 'btn-outline' %>"
                  data-action="filter-group#setCombinator"
                  data-combinator="and">
            AND
          </button>
          <button type="button"
                  class="join-item btn btn-xs w-10 <%= combinator == 'or' ? 'btn-primary' : 'btn-outline' %>"
                  data-action="filter-group#setCombinator"
                  data-combinator="or">
            OR
          </button>
        </div>
      </div>
      <%= render Bali::AdvancedFilters::Condition::Component.new(
            condition: { attribute: '', operator: 'cont', value: '' },
            group_index: index,
            condition_index: '__CONDITION_INDEX__',
            available_attributes: available_attributes
          ) %>
    </div>
  </template>
</div>
