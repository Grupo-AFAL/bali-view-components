<div class="filter-group bg-base-200/50 rounded-xl p-4 relative"
     data-controller="filter-group"
     data-filter-group-index-value="<%= index %>"
     data-advanced-filters-target="group">

  <%# Group header with remove button %>
  <div class="flex items-center justify-between mb-3">
    <span class="text-sm font-medium text-base-content/70">
      <%= t('bali.advanced_filters.where', default: 'Where') %>
    </span>

    <% if removable %>
      <button type="button"
              class="btn btn-ghost btn-xs btn-circle text-error hover:bg-error/10"
              data-action="filter-group#removeGroup"
              title="<%= t('bali.advanced_filters.remove_group', default: 'Remove group') %>">
        <%= render Bali::Icon::Component.new('times', class: 'w-4 h-4') %>
      </button>
    <% end %>
  </div>

  <%# Hidden field for group combinator %>
  <input type="hidden"
         name="<%= group_field_prefix %>[m]"
         value="<%= combinator %>"
         data-filter-group-target="combinator">

  <%# Conditions container %>
  <div data-filter-group-target="conditionsContainer" class="space-y-3">
    <% conditions.each_with_index do |condition, condition_idx| %>
      <%# Clickable combinator badge between conditions %>
      <% if condition_idx > 0 %>
        <div class="flex items-center gap-2 pl-2" data-filter-group-target="combinatorBadge">
          <button type="button"
                  class="badge badge-sm badge-outline font-medium cursor-pointer hover:badge-primary transition-colors"
                  data-action="filter-group#toggleCombinator"
                  title="<%= t('bali.advanced_filters.click_to_toggle', default: 'Click to toggle AND/OR') %>">
            <%= combinator.upcase %>
          </button>
        </div>
      <% end %>

      <%= render Bali::AdvancedFilters::Condition::Component.new(
            condition: condition,
            group_index: index,
            condition_index: condition_idx,
            available_attributes: available_attributes
          ) %>
    <% end %>
  </div>

  <%# Add condition button %>
  <div class="mt-3">
    <button type="button"
            class="btn btn-ghost btn-sm gap-1 text-primary hover:bg-primary/10"
            data-action="filter-group#addCondition">
      <%= render Bali::Icon::Component.new('plus', class: 'w-4 h-4') %>
      <%= t('bali.advanced_filters.add_condition', default: 'Add condition') %>
    </button>
  </div>

  <%# Template for new condition (used by Stimulus) %>
  <template data-filter-group-target="conditionTemplate">
    <%= render Bali::AdvancedFilters::Condition::Component.new(
          condition: { attribute: '', operator: 'cont', value: '' },
          group_index: index,
          condition_index: '__CONDITION_INDEX__',
          available_attributes: available_attributes
        ) %>
  </template>
</div>
