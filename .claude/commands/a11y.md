# Accessibility Audit Command

Audit Bali ViewComponents for WCAG 2.1 accessibility compliance.

## Usage

```
/a11y $ARGUMENTS
```

Where `$ARGUMENTS` is:
- Component name (e.g., `Button`, `Modal`) - Audit specific component
- `--all` - Audit all components
- `--fix` - Auto-fix common issues
- `--level:AA` or `--level:AAA` - Compliance level (default: AA)
- `--report` - Generate detailed HTML report

## Reference

See `docs/guides/accessibility.md` for full accessibility standards.

## Workflow

### Step 1: Read Component Files

For the target component(s), read:
- `component.rb` - Check for ARIA helper methods
- `component.html.erb` - Check markup accessibility
- `preview.rb` - Check preview examples
- Related Stimulus controllers

### Step 2: Run Automated Checks

#### 2.1 Interactive Elements Check

```ruby
# Every interactive element must have:
# - Accessible name (visible text, aria-label, or aria-labelledby)
# - Be keyboard accessible (native element or tabindex)
# - Have visible focus state
```

| Element | Required | Check |
|---------|----------|-------|
| `<button>` | Name | Has text content or aria-label |
| `<a href>` | Name, href | Has text, non-empty href |
| `<input>` | Label | Has associated `<label>` or aria-label |
| `<select>` | Label | Has associated `<label>` or aria-label |
| Custom control | Role, name, state | Has role, aria-label, aria-* states |

#### 2.2 Image Check

```ruby
# All images must have alt attribute
# Decorative images: alt=""
# Informative images: alt="[description]"
```

#### 2.3 Form Check

```ruby
# Every form input must have:
# - Associated label (for= matching id=)
# - Error states with aria-invalid
# - Error messages with aria-describedby
```

#### 2.4 ARIA Pattern Check by Component Type

| Component Type | Required ARIA |
|----------------|---------------|
| Modal/Dialog | role="dialog", aria-modal, aria-labelledby |
| Dropdown/Menu | role="menu", aria-haspopup, aria-expanded |
| Tabs | role="tablist/tab/tabpanel", aria-selected, aria-controls |
| Alert | role="alert" or aria-live |
| Tooltip | role="tooltip", aria-describedby |
| Progress | role="progressbar", aria-valuenow/min/max |
| Toggle | aria-pressed or aria-checked |

#### 2.5 Keyboard Navigation Check

For components with Stimulus controllers, verify:

```javascript
// Required keyboard support
// Modal: ESC to close, Tab trapped inside
// Dropdown: ESC to close, Arrow keys to navigate
// Tabs: Arrow keys to switch, Enter/Space to select
```

### Step 3: Visual Verification (via Playwright)

Use Playwright MCP to check:

1. **Focus Visibility**
   - Tab through all interactive elements
   - Verify focus ring is visible
   - Check focus order is logical

2. **Color Contrast**
   - Screenshot component
   - Check text/background contrast meets 4.5:1

3. **Zoom/Resize**
   - Test at 200% zoom
   - Verify no content is cut off

**Playwright Call Format (CRITICAL)**:
```
skill_mcp(mcp_name="playwright", tool_name="browser_navigate", arguments='{"url": "http://localhost:3001/lookbook/inspect/bali/[component]/default"}')
skill_mcp(mcp_name="playwright", tool_name="browser_snapshot", arguments='{}')
```

### Step 4: Generate Report

```markdown
# Accessibility Audit: [Component]

## Summary
- Compliance Target: WCAG 2.1 Level AA
- Status: PASS / FAIL / NEEDS_REVIEW
- Issues Found: X critical, X serious, X moderate, X minor

## Automated Checks

### Interactive Elements
| Element | Name | Keyboard | Focus | Status |
|---------|------|----------|-------|--------|
| button.btn-primary | "Save" | Yes | Yes | Pass |
| button.btn-circle | MISSING | Yes | Yes | FAIL |

### ARIA Compliance
| Pattern | Required | Found | Status |
|---------|----------|-------|--------|
| role="dialog" | Yes | Yes | Pass |
| aria-modal | Yes | No | FAIL |
| aria-labelledby | Yes | Yes | Pass |

### Form Labels
| Input | Label | Status |
|-------|-------|--------|
| #email | "Email address" | Pass |
| #search | MISSING | FAIL |

## Issues

### Critical (Must Fix)
1. **Missing accessible name on icon button**
   - Location: `component.html.erb:15`
   - Element: `<button class="btn btn-circle">`
   - Fix: Add `aria-label="Close"` attribute
   
   ```erb
   <%# Before %>
   <button class="btn btn-circle">
     <%= render Bali::Icon::Component.new(name: "x") %>
   </button>
   
   <%# After %>
   <button class="btn btn-circle" aria-label="Close">
     <%= render Bali::Icon::Component.new(name: "x") %>
   </button>
   ```

### Serious (Should Fix)
1. **Missing aria-modal on dialog**
   - Location: `component.html.erb:1`
   - Fix: Add `aria-modal="true"` to dialog element

### Moderate (Consider Fixing)
1. **Focus order could be improved**
   - Suggestion: Move close button after content

## Keyboard Navigation

| Action | Key | Expected | Actual | Status |
|--------|-----|----------|--------|--------|
| Open modal | Enter on trigger | Opens | Opens | Pass |
| Close modal | ESC | Closes | Closes | Pass |
| Focus trap | Tab at end | Wraps to start | Exits modal | FAIL |

## Recommendations

1. Add `aria-label` to all icon-only buttons
2. Implement focus trap in modal controller
3. Add skip link support for complex components

## Fix Commands

To auto-fix detected issues:
```
/a11y Modal --fix
```

This will:
- Add missing aria-label attributes
- Add missing role attributes
- Update ARIA states in Stimulus controllers
```

## Auto-Fix Capabilities

When `--fix` is used, the command can automatically fix:

| Issue | Auto-Fix |
|-------|----------|
| Missing alt on images | Add `alt=""` for decorative, flag for review if informative |
| Missing aria-label on icon buttons | Add aria-label based on icon name |
| Missing role on custom elements | Add appropriate role attribute |
| Missing aria-expanded on triggers | Add to triggers with targets |
| Missing label associations | Add for= to labels, id= to inputs |

**Cannot auto-fix (requires manual review):**
- Complex keyboard navigation
- Focus trap implementation
- Custom screen reader announcements
- Color contrast issues

## Component-Specific Requirements

### Button
```ruby
# Required
- Accessible name (text or aria-label)
- type attribute for form buttons
- aria-pressed for toggle buttons
- aria-disabled (not just disabled attribute)
```

### Modal
```ruby
# Required
- role="dialog" or <dialog> element
- aria-modal="true"
- aria-labelledby pointing to title
- Focus trap (Stimulus controller)
- Return focus on close
```

### Dropdown
```ruby
# Required
- aria-haspopup="true" on trigger
- aria-expanded on trigger
- aria-controls pointing to menu
- role="menu" on menu
- role="menuitem" on items
- Keyboard navigation (Arrow keys)
```

### Tabs
```ruby
# Required
- role="tablist" on container
- role="tab" on tabs
- role="tabpanel" on panels
- aria-selected on active tab
- aria-controls/aria-labelledby connections
- Arrow key navigation
```

### Form Inputs
```ruby
# Required
- Associated <label> with for/id
- aria-invalid="true" on error
- aria-describedby for error messages
- aria-required for required fields
```

### Alert/Notification
```ruby
# Required
- role="alert" for important messages
- aria-live="polite" for non-critical
- aria-live="assertive" for critical
- aria-atomic="true" for updates
```

## Example Execution

```
User: /a11y Modal

AI: Running accessibility audit on Bali::Modal::Component...

# Accessibility Audit: Modal

## Summary
- Compliance Target: WCAG 2.1 Level AA
- Status: NEEDS_FIXES
- Issues Found: 1 critical, 2 serious, 0 moderate

## Automated Checks

### Interactive Elements
| Element | Name | Keyboard | Focus | Status |
|---------|------|----------|-------|--------|
| button (close) | MISSING | Yes | Yes | FAIL |
| button (cancel) | "Cancel" | Yes | Yes | Pass |
| button (confirm) | "Confirm" | Yes | Yes | Pass |

### ARIA Compliance
| Pattern | Required | Found | Status |
|---------|----------|-------|--------|
| role="dialog" | Yes | Yes | Pass |
| aria-modal | Yes | No | FAIL |
| aria-labelledby | Yes | Yes | Pass |
| focus trap | Yes | No | FAIL |

## Issues

### Critical
1. **Icon button missing accessible name**
   - Element: Close button (X icon)
   - Fix: Add `aria-label="Close dialog"`

### Serious
1. **Missing aria-modal attribute**
   - Fix: Add `aria-modal="true"` to dialog

2. **No focus trap implemented**
   - Fix: Update Stimulus controller to trap focus

## Fixes Available

Run `/a11y Modal --fix` to apply:
- [ ] Add aria-label="Close dialog" to close button
- [ ] Add aria-modal="true" to dialog element

Manual fixes needed:
- [ ] Implement focus trap in modal_controller.js

Apply automatic fixes? [y/n]
```

```
User: y

AI: Applying fixes...

Updated: app/components/bali/modal/component.html.erb
- Added aria-label="Close dialog" to close button
- Added aria-modal="true" to dialog element

Remaining manual fix:
- Implement focus trap in modal_controller.js

See docs/reference/stimulus-patterns.md for focus trap implementation.

Re-running audit...

## Updated Summary
- Status: NEEDS_REVIEW (1 manual fix remaining)
- Issues: 0 critical, 0 serious, 1 requires manual implementation
```

## Integration

### With /audit Command

```bash
/audit --a11y  # Shows a11y status for all components
```

### With /component-cycle

```bash
/component-cycle Modal  # Includes a11y check in verification
```

### With /verify-component

```bash
/verify-component Modal  # Includes a11y in report
```
